<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Payment Processing</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Test Payment Processing</h1>
    <div id="status">Loading...</div>
    <div id="results"></div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://qaffpsbiciegxxonsxzl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhZmZwc2JpY2llZ3h4b25zeHpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NDEyMzgsImV4cCI6MjA3ODMxNzIzOH0.Rfb4WfqYHCGwZHv8HE3OxUSZbpEFqTfAnL0K4jaFnZU';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        async function testPaymentMethods() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            try {
                // Test 1: Check if user is authenticated
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                
                if (authError || !user) {
                    statusDiv.innerHTML = '<p style="color: red;">User not authenticated. Please log in first.</p>';
                    return;
                }
                
                statusDiv.innerHTML = '<p style="color: green;">User authenticated: ' + user.email + '</p>';
                
                // Test 2: Check if payment method columns exist
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('apple_pay_id, google_wallet_id, chime_id, cashapp_id, message_charge_amount, message_charge_enabled')
                    .eq('id', user.id)
                    .single();
                
                if (profileError) {
                    resultsDiv.innerHTML += '<p style="color: red;">Error fetching profile: ' + profileError.message + '</p>';
                    return;
                }
                
                resultsDiv.innerHTML += '<h3>Profile Payment Methods:</h3>';
                resultsDiv.innerHTML += '<pre>' + JSON.stringify(profile, null, 2) + '</pre>';
                
                // Test 3: Check if earnings_config table exists
                const { data: config, error: configError } = await supabase
                    .from('earnings_config')
                    .select('*')
                    .limit(1);
                
                if (configError) {
                    resultsDiv.innerHTML += '<p style="color: red;">Error fetching earnings config: ' + configError.message + '</p>';
                } else {
                    resultsDiv.innerHTML += '<h3>Earnings Config:</h3>';
                    resultsDiv.innerHTML += '<pre>' + JSON.stringify(config, null, 2) + '</pre>';
                }
                
                // Test 4: Test Edge Function availability
                try {
                    const { data, error } = await supabase.functions.invoke('processUserPaymentMethod', {
                        body: {
                            userId: user.id,
                            method: 'apple_pay',
                            methodId: 'test_method_id',
                            amount: 100,
                            currency: 'USD',
                            description: 'Test payment',
                            coinAmount: 100,
                            idempotency_key: 'test-' + Date.now()
                        }
                    });
                    
                    if (error) {
                        resultsDiv.innerHTML += '<p style="color: orange;">Edge Function error (expected for test): ' + error.message + '</p>';
                    } else {
                        resultsDiv.innerHTML += '<p style="color: green;">Edge Function response: ' + JSON.stringify(data) + '</p>';
                    }
                } catch (funcError) {
                    resultsDiv.innerHTML += '<p style="color: orange;">Edge Function not available (expected): ' + funcError.message + '</p>';
                }
                
                statusDiv.innerHTML += '<p style="color: green;">All tests completed!</p>';
                
            } catch (error) {
                statusDiv.innerHTML = '<p style="color: red;">Error: ' + error.message + '</p>';
                console.error('Test error:', error);
            }
        }
        
        // Run tests when page loads
        testPaymentMethods();
    </script>
</body>
</html>